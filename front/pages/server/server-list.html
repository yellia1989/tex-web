<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>服务管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="/css/oksub.css">
  <script type="text/javascript" src="/lib/loading/okLoading.js"></script>
</head>

<body>
  <div class="ok-body">
    <form class="layui-form">
      <div class="layui-form-item">
        <div class="layui-inline">

          <div class="layui-input-inline">
            <input class="layui-input" placeholder="请输入应用名" autocomplete="off" name="app">
          </div>
          <div class="layui-input-inline">
            <input class="layui-input" placeholder="请输入服务名" autocomplete="off" name="server">
          </div>
          <div class="layui-input-inline">
            <input class="layui-input" placeholder="请输入分区" autocomplete="off" name="division">
          </div>
          <div class="layui-input-inline">
            <input class="layui-input" placeholder="请输入节点" autocomplete="off" name="node">
          </div>

          <div class="layui-input-inline">
            <button class="layui-btn" lay-submit lay-filter="search">
              <i class="layui-icon layui-icon-search"></i>
            </button>
          </div>

        </div>
      </div>
    </form>

    <table id="tableId" lay-filter="tableFilter"></table>
  </div>

  <!--js逻辑-->
  <script src="/lib/layui/layui.js"></script>
  <script>
    var taskNo;
    var editData;
    var editServer;
    layui.use(["dropdown", "element", "table", "form", "layer", "okUtils", "okLayer"], function () {
      let table = layui.table;
      let layer = layui.layer;
      let okUtils = layui.okUtils;
      let form = layui.form;
      let okLayer = layui.okLayer;
      let dropdown = layui.dropdown;
      okLoading.close();

      let serverTable = table.render({
        elem: "#tableId",
        url: "/api/server/list",
        text: {
          none: '暂无相关数据',
        },
        limit: 30,
        page: true,
        toolbar: "#toolbarTpl",
        defaultToolbar: ['filter'],
        cols: [[
          { type: "checkbox", title: "序号", fixed: 'left' },
          { field: "app", title: "应用", fixed: 'left', minWidth: '100' },
          { field: "server", title: "服务", fixed: 'left', minWidth: '120' },
          { field: "division", title: "分区", fixed: 'left', minWidth: '140' },
          { field: "node", title: "节点", fixed: 'left', minWidth: '140' },
          {
            field: "cur_stat", title: "当前状态", minWidth: '80', templet: function (d) {
              switch (d.cur_stat) {
                case 0: return "<font color='#FF5722'>停止</font>";
                case 1: return "<font color='#5FB878'>运行中</font>";
                case 2: return "<font color='#FFB800'>启动中</font>";
                case 3: return "<font color='#FFB800'>停止中</font>";
                case 4: return "<font color='#FFB800'>更新文件下载中</font>";
                case 5: return "<font color='#FFB800'>更新文件下载完成</font>";
                default: return "未知状态: " + d.cur_stat;
              }
            }
          },
          { field: "start_time", title: "运行时间", minWidth: '80', templet: function(d) {
              if (d.start_time != 0) {
                return okUtils.displayInterval(Date.now()/1000 - d.start_time);
              } else {
                return "-";
              }
            }
          },
          { field: "pid", title: "进程ID", minWidth: '80' },
          { field: "prom_port", title: "监听端口", minWidth: '80' },
          {
            field: "auto_start", title: "自动重启", align: "center", minWidth: '80', templet: function (d) {
              switch (d.auto_start) {
                case 1: return "是";
                case 0: return "<font color='#FF5722'>否</font>";
              }
            }
          },
          {
            field: "manual_stop", title: "手动停止", align: "center", minWidth: '80', templet: function (d) {
              switch (d.manual_stop) {
                case 1: return "是";
                case 0: return "<font color='#FF5722'>否</font>";
              }
            }
          },
          { field: "template_name", title: "模板名", minWidth: '120'},
          { field: "publish_version", title: "版本", minWidth: '120'},
          { field: "publish_username", title: "发布人", align: "center",minWidth: '100'},
          { field: "publish_time", title: "发布时间", align: "center", minWidth: '160' },
          { title: "操作", align: "center", templet: "#operationTpl", fixed: 'right', minWidth: '280' }
        ]]
      });

      function serverOperator(data, cmd) {
        let vItem = [{ "sApp": data.app, "sServer": data.server, "sDivision": data.division, "sNodeName": data.node, "sCommand": cmd }]
        let req = {
          "vItem": JSON.stringify(vItem),
        }
        okUtils.ajax("/api/server/operator", "post", req, true).done(function (response) {
          taskNo = response.data;
          let param = {
            type: 2,
            title: "任务详情",
            content: "./task-info.html",
            area: ['80%', "80%"],
            end: function () {
              serverTable.reload();
            }
          }
          layer.open(param);
        }).fail(function (error) {
          console.log(error.msg);
        });
      }

      function setLogLevel(data) {
        editData = data;
        okLayer.open("设置日志等级", "./setloglevel.html", "50%", "50%", null, function () {
        });
      }

      function copyData(data) {
        editData = data;
        editData.copy = true;
        okLayer.open("增加服务", "./server-add.html", "90%", "90%", null, function () {
          serverTable.reload();
        });
      }

      table.on("tool(tableFilter)", function (obj) {
        let that = this;
        let data = obj.data;
        switch (obj.event) {
          case "edit":
            edit(data);
            break;
          case "publish":
            editServer = data;
            openPublish();
            break;
          case "stop":
          case "start":
          case "restart":
            serverOperator(data, obj.event);
            break;
          case "more":
            //更多下拉菜单
            dropdown.render({
              elem: that
              , show: true //外部事件触发即显示
              , data: [{
                title: '设置日志等级'
                , id: 'set_log_level'
              },
              {
                title: '复制'
                , id: 'copy'
              }]
              , click: function (data2, othis) {
                console.log(data2);
                if (data2.id == 'copy') {
                  copy(data);
                } else if (data2.id == 'set_log_level') {
                  setLogLevel(data);
                }
              }
              ,align: 'right' //右对齐弹出（v2.6.8 新增）
              ,style: 'box-shadow: 1px 1px 10px rgb(0 0 0 / 12%);' //设置额外样式
            });
            break;
        }
      });

      table.on("toolbar(tableFilter)", function (obj) {
        switch (obj.event) {
          case "batchStop":
            batchOperator("stop");
            break;
          case "batchStart":
            batchOperator("start");
            break;
          case "batchRestart":
            batchOperator("restart");
            break;
          case "add":
            add();
            break;
          case "batchDel":
            batchDel();
            break;
        }
      });

      form.on("submit(search)", function (data) {
        serverTable.reload({
          url: "/api/server/list",
          where: data.field,
          page: {
            curr: 1,
          }
        });
        return false;
      });

      function openPublish() {
        let param = {
          type: 2,
          title: "发布",
          content: "./publish-list.html",
          area: ['90%', "90%"],
          end: function () {

          },
        }
        layer.open(param);
      }

      function batchOperator(cmd) {
        let checkStatus = table.checkStatus("tableId");
        if (checkStatus.data.length == 0) {
          layer.msg("未选择有效数据", { offset: "t", anim: 6 });
          return;
        }
        let vItem = [];
        for (let v of checkStatus.data) {
          vItem.push({ "sApp": v.app, "sServer": v.server, "sDivision": v.division, "sNodeName": v.node, "sCommand": cmd });
        }

        let req = {
          "vItem": okUtils.jsonToString(vItem),
        }
        okUtils.ajax("/api/server/operator", "post", req, true).done(function (response) {
          taskNo = response.data;
          let param = {
            type: 2,
            title: "任务详情",
            content: "./task-info.html",
            area: ['80%', "80%"],
            end: function () {
              serverTable.reload();
            }
          }
          layer.open(param);
        }).fail(function (error) {
          console.log(error.msg);
        });
      }

      function add() {
        okLayer.open("增加服务", "./server-add.html", "90%", "90%", null, function () {
          serverTable.reload();
        });
      }

      function batchDel() {
        okLayer.confirm("确定要批量删除吗？", function (index) {
          layer.close(index);
          let checkStatus = table.checkStatus("tableId");
          if (checkStatus.data.length == 0) {
            layer.msg("未选择有效数据", { offset: "t", anim: 6 });
            return;
          }
          let servers = [];
          for (let v of checkStatus.data) {
            servers.push({ "app": v.app, "server": v.server, "division": v.division, "node": v.node });
          }

          let req = {
            "servers": okUtils.jsonToString(servers),
          }
          okUtils.ajax("/api/server/del", "post", req, true).done(function (response) {
            okUtils.tableSuccessMsg(response.data);
          }).fail(function (error) {
            console.log(error)
          });
        });
      }

      function edit(data) {
        editData = data;
        okLayer.open("编辑服务", "./server-edit.html", "90%", "90%", null, function () {
          serverTable.reload();
        });
      }
    });
  </script>

  <script type="text/html" id="operationTpl">
    <a href="javascript:" title="编辑" lay-event="edit">编辑</a>
    <a href="javascript:" title="停止" lay-event="stop">停止</a>
    <a href="javascript:" title="启动" lay-event="start">启动</a>
    <a href="javascript:" title="重启" lay-event="restart">重启</a>
    <a href="javascript:" title="发布" lay-event="publish">发布</a>
    <a class="layui-btn layui-btn-xs" lay-event="more">更多 <i class="layui-icon layui-icon-down"></i></a>
  </script>

  <script type="text/html" id="toolbarTpl">
    <div class="layui-inline" lay-event="add"><i class="layui-icon layui-icon-add-1"></i></div>
    <div class="layui-inline" lay-event="batchDel"><a href="javascript:" title="批量删除"><i class="layui-icon layui-icon-delete"></i></a></div>
    <span style="cursor:pointer" lay-event="batchStop">停止</span>
    <span style="cursor:pointer" lay-event="batchStart">启动</span>
    <span style="cursor:pointer" lay-event="batchRestart">重启</span>
  </script>

</body>

</html>
